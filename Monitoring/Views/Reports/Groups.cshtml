@model IEnumerable<Monitoring.Models.education__institution>
@{
    ViewBag.Title = ViewBag.name;
}

<div class="container" style="margin-top: 50px;">

    <a href="/Reports/Index">Вернуться к отчетам</a>
    <h4>Процент несоответствия Интернет-сайтов требованиям нормативно-правовых актов: <br/>
        @ViewBag.name
    </h4>

    <script>
        var data_result_1 = [];
        var data_result_2 = [];
        var data_result_3 = [];
        var data_result_4 = [];
    </script>


        <table>
            <thead>
                <tr>
                    <th rowspan="2">Области</th>
                    <th rowspan="2">Всего интернет-сайтов</th>
                    <th rowspan="2">из них проверено</th>
                    <th colspan="6">из них:</th>
                    <th rowspan="2">число непровереных сайтов</th>
                    <th rowspan="2">% от общего количества</th>
                </tr>
                <tr>
                    <th><=20% ошибок</th>
                    <th>% от общего количества</th>
                    <th>20% - 70% ошибок</th>
                    <th>% от общего количества</th>
                    <th>>=70% ошибок</th>
                    <th>% от общего количества</th>
                </tr>
            </thead>
            <tbody>

                @foreach (var item in ViewBag.areas)
                {
                    {ViewBag.q1 = (Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) <= ViewBag.err20) * (double)100) / Model.Count(p => p.district.area_id == item.id);
                        ViewBag.q2 = (Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) > ViewBag.err20 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) < ViewBag.err70) * (double)100) / Model.Count(p => p.district.area_id == item.id);
                        ViewBag.q3 = (Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) >= ViewBag.err70) * (double)100) / Model.Count(p => p.district.area_id == item.id);
                        ViewBag.q4 = (Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) == 0) * (double)100) / Model.Count(p => p.district.area_id == item.id);
                    }
                    <tr>
                        <td>
                            <script>
                                data_result_1.push("@Math.Round(ViewBag.q1, 0)");
                                data_result_2.push("@Math.Round(ViewBag.q2, 0)");
                                data_result_3.push("@Math.Round(ViewBag.q3, 0)");
                                data_result_4.push("@Math.Round(ViewBag.q4, 0)");
                            </script>
                        @item.name</td>
                        <td>@Model.Count(p => p.district.area_id == item.id)</td>
                        <td>@Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0)</td>
                        <td>@Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) <= ViewBag.err20)</td>
                        <td>@Math.Round(ViewBag.q1, 2) %</td>
                        <td>@Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) > ViewBag.err20 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) < ViewBag.err70)</td>
                        <td>@Math.Round(ViewBag.q2, 2) %</td>
                        <td>@Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) >= ViewBag.err70)</td>
                        <td>@Math.Round(ViewBag.q3, 2) %</td>
                        <td>@Model.Count(p => p.district.area_id == item.id && p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) == 0)</td>
                        <td>@Math.Round(ViewBag.q4, 2) %</td>
                    </tr>
                }
                <tr>
                    <td><b>Всего по РБ:</b></td>
                    <td><b>@Model.Count()</b></td>
                    <td><b>@Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0)</b></td>
                    <td><b>@Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && (p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) <= ViewBag.err20))</b></td>
                    <td><b>@Math.Round((Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && (p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) <= ViewBag.err20)) * (double)100) / Model.Count(), 2) %</b></td>
                    <td><b>@Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) > ViewBag.err20 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) < ViewBag.err70)</b></td>
                    <td><b>@Math.Round((Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) > ViewBag.err20 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) < ViewBag.err70) * (double)100) / Model.Count(), 2) %</b></td>
                    <td><b>@Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) >= ViewBag.err70)</b></td>
                    <td><b>@Math.Round((Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) > 0 && p.audit_object.site_experts.First().Experts_comments.Count(s => s.answer == 0 && s.Criteria.group_id == ViewBag.group) >= ViewBag.err70) * (double)100) / Model.Count(), 2) %</b></td>
                    <td><b>@Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) == 0)</b></td>
                    <td><b>@Math.Round((Model.Count(p => p.audit_object.Rating.Count(s => s.monitoring_id == ViewBag.monitoring) == 0) * (double)100) / Model.Count(), 2) %</b></td>
                </tr>
            </tbody>
        </table>
    <div class="col-md-8">
        <canvas id="graphic" width="400" height="400"></canvas>
    </div>

</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
<script>
    var ctx = document.getElementById("graphic").getContext('2d');
    var label_arr = [];
    </script>
    @foreach (var item in ViewBag.areas)
    {
        <script>
            label_arr.push("@item.name");
        </script>
    }
<script>
            console.log(label_arr);
    var myChart = new Chart(ctx, {
        type: 'bar',
    data: {
        labels: label_arr,
        datasets: [{
            label: '<=20% ошибок',
            data: data_result_1,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
        },
            {
                label: '20% - 70% ошибок',
                data: data_result_2,
                backgroundColor: 'rgba(255, 206, 86, 0.2)'
            },
            {
                label: '>=70% ошибок',
                data: data_result_3,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
            },
            {
                label: '% непровереных сайтов',
                data: data_result_4,
                backgroundColor: 'rgb(211, 211, 211, 0.2)',
            },
        ]
        },
    options: {
        scales: {
            xAxes: [{
                stacked: true
            }],
            yAxes: [{
                stacked: true,
                ticks: {
                    min: 0,
                    max: 100,
                    stepSize: 25
                }
            }]
        }
    }
});
    
</script>